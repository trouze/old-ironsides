name: dbt Cloud multi-project CI

on:
  pull_request:

jobs:
  # JOB to run change detection
  changes:
    runs-on: ubuntu-latest
    # Required permissions
    permissions:
      pull-requests: read
    outputs:
      # Expose matched filters as job 'packages' output variable
      projects: ${{ steps.filter.outputs.changes }}
    steps:
    # For pull requests it's not necessary to checkout the code
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          dbt_sandbox:
            - 'macros/**'
            - 'models/**'
            - 'snapshots/**'
            - 'tests/**'
            - 'seeds/**'

  # JOB to build and test each of modified packages
  dbt-cloud-ci:
    needs: changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # TODO: set dynamically based on ${{ fromJSON(needs.changes.outputs.projects) }}
        # but I'm not sure how to dynamically set the other variables in a way that feels this clean
        include:
          - project: dbt_sandbox
            project_id: 376310
            job_id: 713662

    # Set the environment variables needed for the run
    env:
      DBT_ACCOUNT_ID: 51798 # enter your account id
      DBT_PROJECT_ID: ${{ matrix.project_id }} # enter your project id
      DBT_PR_JOB_ID: ${{ matrix.job_id }} # enter your job id
      DBT_API_KEY: ${{ secrets.DBT_API_KEY }}
      DBT_JOB_CAUSE: 'GitHub Pipeline CI Job'
      DBT_JOB_BRANCH: ${{ github.head_ref }}
      DBT_JOB_SCHEMA_OVERRIDE: ${{ github.event.pull_request.number }}

    steps:
      - uses: "actions/checkout@v3"
        if: ${{ contains(fromJSON(needs.changes.outputs.projects), matrix.project) }}
      - uses: "actions/setup-python@v4"
        with:
          python-version: "3.9"
        if: ${{ contains(fromJSON(needs.changes.outputs.projects), matrix.project) }}
      - name: Run dbt Cloud job
        run: "python utils/dbt_cloud_ci_caller.py"
        if: ${{ contains(fromJSON(needs.changes.outputs.projects), matrix.project) }}
